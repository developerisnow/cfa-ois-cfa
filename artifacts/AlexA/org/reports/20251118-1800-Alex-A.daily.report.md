---
created: 2025-11-18 18:00
updated: 2025-11-18 23:55
type: daily-report
sphere: exchange
topic: NX-01-04-specs-and-order-flow
author: alex-a
agentID: human-alex-a
partAgentID: [co-76ca]
version: 1.2.0
tags: [daily-report, nx-01, nx-02, nx-03, nx-04, specs, api-matrix, order-flow]
---

# Daily Report — 2025-11-18 — Alex A

## 1. Контекст дня
- Сервисы/приложения:
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/packages/contracts/*`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/PROJECT-CONTEXT.md`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/services/issuance`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/services/registry`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/services/settlement`
- Задачи:
  - `NX-01-spec-validate-and-matrix`
  - `NX-02-gateway-routing-and-health`
  - `NX-03-issuance-endpoints-coverage`
  - `NX-04-registry-orders-flow`
- Ссылки на контекст:
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/PROJECT-CONTEXT.md`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/WBS-OIS.md`
  - `repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/RULES-SUMMARY.md`

_Примечание по gitflow_: по факту все изменения NX‑01..NX‑04 выполнены в одной ветке `tasks/NX-01-spec-validate-and-matrix` от `infra.defis.deploy`. Это осознанное отступление от идеала (по ветке на NX‑таск). В MR нужно явно зафиксировать, что ветка NX‑01 в этом цикле включает NX‑02..NX‑04 (будущие ветки можно сделать более гранулярными).

## 2. Краткие итоги дня (3–7 буллетов)
- Перепроверил OpenAPI/AsyncAPI/JSON Schemas на ветке `infra.defis.deploy` (NX‑01 v2) через Spectral, AsyncAPI CLI и AJV, добавил артефакты `spec-*`.
- Обновил `PROJECT-CONTEXT.md`: зафиксировал NX‑01 v2, добавил маркеры API/Event Matrix и Gap List, актуализировал Event Matrix/Gaps после NX‑04 (order events).
- Для NX‑02 добавил `make check-health`, обновил `artifacts/gateway-routing-report.md`, проверил health‑команду (без поднятого стека — как scaffold).
- Настроил .NET 8/9 в окружении Codex, собрал и запустил тесты для Issuance, Registry и Settlement (NX‑03/04) — в т.ч. с фиксацией багов.
- Для NX‑03 поднял `tests/issuance.Tests`: unit‑тест зелёный, найден и задокументирован failing API‑тест `Publish_NonExistent_Should_Return_404` (500 вместо 404).
- Для NX‑04 реализовал полный order‑flow в Registry (`created/placed/reserved/paid/confirmed/registry.transferred`), обновил OutboxPublisher и OrderFlowTests; все `registry.Tests` зелёные.
- Дополнительно прогнал `settlement.Tests` для подтверждения, что потребление `ois.order.paid` и settlement‑сервис собираются и тесты зелёные.

## 3. Детализация по задачам

### Задача: NX‑01 — Spec validation + API/Event Matrix (`tasks/NX-01-spec-validate-and-matrix.md`)

- Цель (кратко): гарантировать, что спеки OpenAPI/AsyncAPI/JSON Schemas валидны, а API/Event Matrix в `PROJECT-CONTEXT.md` отражает фактическое состояние ветки `infra.defis.deploy`.

- Сделано:
  - Запустил Spectral lint по всем `packages/contracts/openapi-*.yaml` — нет ошибок уровня error.
  - Запустил `@asyncapi/cli validate` для `packages/contracts/asyncapi.yaml` — документ валиден, только governance‑warnings (id/tags/messageId).
  - Прогнал AJV `compile` по всем `packages/contracts/schemas/*.json` — ожидемые предупреждения по `format: "uuid"` и `format: "decimal"`.
  - Обновил `docs/context/PROJECT-CONTEXT.md`:
    - `Last Updated` → NX‑01 re-check на `infra.defis.deploy`.
    - Обернул API/Event Matrix и Gap List в `<!-- BEGIN/END -->`.
    - После NX‑04 обновил Events Matrix и Gap List: снял SPEC DIFF для `ois.order.placed`/`ois.order.confirmed`, оставил только `ois.payout.scheduled` и `ois.transfer.completed`.

- Кодовые изменения:
  - `docs/context/PROJECT-CONTEXT.md`
  - `artifacts/spec-lint-openapi.txt`
  - `artifacts/spec-validate-asyncapi.txt`
  - `artifacts/spec-validate-jsonschema.txt`

- Статус:
  - **ready for review** — NX‑01 v2 для `infra.defis.deploy` выполнен; спеки валидны, Event Matrix актуальна.

### Задача: NX‑02 — Gateway routing + health/metrics (`tasks/NX-02-gateway-routing-and-health.md`)

- Цель (кратко): убедиться, что маршрутизация API Gateway через YARP соответствует OpenAPI, у всех core‑сервисов есть `/health`, и есть единая команда для health‑проверки.

- Сделано:
  - Просмотрел `apps/api-gateway/appsettings.json`, проверил, что YARP routes/clusters соответствуют матрице в `artifacts/gateway-routing-report.md`.
  - Добавил `make check-health` в корневой `Makefile`, проверяющий `/health` для gateway и основных сервисов (`identity`, `issuance`, `registry`, `settlement`, `compliance`, `bank-nominal`) на портах `5000-5007`.
  - Запустил `make check-health` — команда работает, но без поднятого docker‑стека все сервисы ожидаемо `FAILED` (фиксируем как scaffold).
  - Обновил `artifacts/gateway-routing-report.md`: добавил `Re-checked: 2025-11-18 (infra.defis.deploy, NX-02 v2)` и актуализировал секцию Verification Commands.

- Кодовые изменения:
  - `Makefile` — цель `check-health`.
  - `artifacts/gateway-routing-report.md`.

- Статус:
  - **in progress** — wiring и документация готовы; нужен запуск `make check-health` на живом стеке и, при необходимости, доработка health/metrics для интеграций.

### Задача: NX‑03 — Issuance endpoints alignment + tests (`tasks/NX-03-issuance-endpoints-coverage.md`)

- Цель (кратко): убедиться, что реализация Issuance соответствует OpenAPI/AsyncAPI, а happy‑path покрыт тестами сервиса и API.

- Сделано:
  - Установил `.NET 8/9` и собрал `services/issuance` под `net9.0`.
  - Привёл в порядок тестовый проект Issuance:
    - Исправил `ProjectReference` в `services/issuance/issuance.Tests.csproj`.
    - Добавил недостающие `using` в `IssuanceService`, `OutboxPublisher` и `Program.cs` для .NET 9.
    - Добавил `Microsoft.TestPlatform.TestHost` для корректного запуска tests.
  - Запустил:

    ```bash
    $HOME/.dotnet/dotnet test tests/issuance.Tests/issuance.Tests.csproj -v minimal
    ```

    - Unit: `IssuanceServiceTests.CreateAsync_ShouldCreateDraftIssuance` — ✅ зелёный.
    - API: `Publish_NonExistent_Should_Return_404` — ❌ красный (ожидает 404, фактически 500).

  - Создал `artifacts/issuance-test-report.txt` с фиксацией команды, результатов и текущего SPEC DIFF по Issuance events (`dltTxHash` vs AsyncAPI).

- Кодовые изменения:
  - `services/issuance/issuance.Tests.csproj`
  - `services/issuance/Services/IssuanceService.cs`
  - `services/issuance/Background/OutboxPublisher.cs`
  - `services/issuance/Program.cs`
  - `artifacts/issuance-test-report.txt`.

- Статус:
  - **in progress** — инфраструктура и тесты настроены, баг `Publish_NonExistent` воспроизводится и задокументирован; сам фикс поведения (404 vs 500) сознательно отложен в отдельную итерацию.

### Задача: NX‑04 — Registry: поток заказа (create→reserve→paid) + события (`tasks/NX-04-registry-orders-flow.md`)

- Цель (кратко): довести поток заказа в Registry (create→reserve→paid) до состояния, где код соответствует OpenAPI/AsyncAPI, события покрывают order lifecycle, а happy‑path покрыт тестами.

- Сделано:
  - Изучил `openapi-registry.yaml` и `asyncapi.yaml` по order‑событиям (`OrderCreated/Placed/Reserved/Paid/Confirmed`).
  - В `packages/domain/IntegrationEvents.cs` добавил:
    - `OrderPlaced` (orderId, investorId, issuanceId, amount, placedAt).
    - `OrderConfirmed` (orderId, confirmedAt, dltTxHash, walletId).
  - В `RegistryService.PlaceOrderAsync`:
    - Оставил логику KYC/qualification, idempotency по `IdemKey`, создание `OrderEntity` со статусом `created`.
    - Добавил события `ois.order.created` и **новое** `ois.order.placed` в outbox до вызова Bank.
    - Сохранил резервацию средств через `_bank.ReserveFundsAsync` и `ois.order.reserved` (как было).
  - В `RegistryService.MarkPaidAsync`:
    - Сохранил проверку статусов (`reserved` → paid, idempotent для `"paid"`).
    - После успешного `TransferAsync` и обновления order/wallet/holdings:
      - публикую `ois.order.paid` (OrderPaidPayload),
      - публикую **новое** `ois.order.confirmed` (OrderConfirmedPayload),
      - публикую `ois.registry.transferred` (RegistryTransferredPayload).
  - Обновил `OutboxPublisher` (Registry) для новых топиков:
    - Добавил обработку `ois.order.placed` → `OrderPlaced`.
    - Добавил обработку `ois.order.confirmed` → `OrderConfirmed`.
  - Обновил `OrderFlowTests`:
    - `PlaceOrder_IsIdempotent_And_Reserved` теперь проверяет, что для idempotent‑flow есть события `ois.order.created`, `ois.order.placed`, `ois.order.reserved`.
    - `MarkPaid_Moves_To_Paid_And_Writes_Tx` проверяет статус `paid`, запись в `Transactions` и события `ois.order.paid`, `ois.order.confirmed`, `ois.registry.transferred` в outbox.
  - Создал `artifacts/registry-flow-report.md` с REST/AsyncAPI mapping и описанием тестов.

- Кодовые изменения:
  - `packages/domain/IntegrationEvents.cs`
  - `services/registry/Services/RegistryService.cs`
  - `services/registry/Background/OutboxPublisher.cs`
  - `services/registry/registry.Tests/OrderFlowTests.cs`
  - `artifacts/registry-flow-report.md`.

- Тесты:

  ```bash
  $HOME/.dotnet/dotnet test services/registry/registry.Tests/registry.Tests.csproj -v minimal
  ```

  - Все 9 тестов в `registry.Tests` — ✅ Passed (включая OrderFlowTests).

- Статус:
  - **ready for review** — order‑flow и события Registry соответствуют спекам и покрыты тестами; дальше — e2e и интеграция с Settlement/фронтами.

## 4. Артефакты и метрики за день

- Создано/обновлено в `repositories/customer-gitlab/wt__ois-cfa__NX01/artifacts/`:
  - `spec-lint-openapi.txt` — подтверждение корректности OpenAPI без blocking errors.
  - `spec-validate-asyncapi.txt` — текущие governance‑warnings по AsyncAPI.
  - `spec-validate-jsonschema.txt` — состояние JSON Schemas с точки зрения AJV.
  - `issuance-test-report.txt` — результат запуска Issuance API/Service тестов (NX‑03).
  - `gateway-routing-report.md` — обновлённый отчёт NX‑02 (YARP и health).
  - `registry-flow-report.md` — новый отчёт NX‑04 по order‑flow и событиям.
- Метрики:
  - Отдельные runtime‑метрики не снимались (фокус на спеках и unit/integration тестах).

## 5. Риски, блокеры, зависимости

- Риски:
  - Если не договориться по форматам (`uuid`/`decimal`) и governance rules в AsyncAPI, warnings могут мешать жёстким CI‑гейтам.
  - Failing API‑тест Issuance (`Publish_NonExistent_Should_Return_404`) показывает реальный behaviour gap (500 vs 404); перед фиксом нужно аккуратно принять решение, что именно считать каноничным.
- Блокеры:
  - По NX‑01/02/04 блокеров нет (всё в рамках acceptance).
  - По NX‑03 блокер — отсутствие согласованного решения по поведению Publish NonExistent (пока намеренно не трогал бизнес‑логику).
- Зависимости:
  - NX‑02..NX‑04 зависят от того, что текущий слой спецификаций и Event Matrix в `PROJECT-CONTEXT.md` остаётся SSOT.

## 6. План на следующий день

- Для NX‑02:
  - Прогнать `make check-health` на поднятом docker‑compose стеке и убедиться, что все сервисы возвращают 200/OK на `/health`.
  - При необходимости доработать health/metrics для интеграций (ESIA/EDO) и дополнить `gateway-routing-report.md`.
- Для NX‑03:
  - Повторно прогнать `dotnet test tests/issuance.Tests/issuance.Tests.csproj` на eywa1 и подтвердить/уточнить поведение `Publish_NonExistent_Should_Return_404`.
  - Принять решение: либо править API/обработку исключений для `Publish_NonExistent`, либо зафиксировать отклонение как Known Issue с явным SPEC DIFF.
- Для NX‑04:
  - При необходимости добавить contract/e2e‑тесты, покрывающие связку Registry → Settlement для `ois.order.paid` / `ois.registry.transferred`.
  - Привязать обновлённый Registry order‑flow к фронту (портфель/история/отчёты) в следующих задачах (NX‑05+).

## 7. Заметки по взаимодействию с ИИ-агентами

- Использованные промпты/контексты:
  - GPT‑5 Pro Oracle (run1 и последующие) для NX‑серии как дизайн‑слой для API/Event Matrix, RepoScan и T/B/L.
  - Контекст из `memory-bank/snapshots-aggregated-context-duplicates/20251117-c2p_ois-cfa.txt` и aggregated GPT‑5 отчётов.
- На завтра ИИ‑агенту:
  - Нужен актуальный `PROJECT-CONTEXT.md` (уже обновлён), результаты `spec-*`, `issuance-test-report.txt`, `registry-flow-report.md` и чёткое указание, какие NX‑таски считаются закрытыми (NX‑01/02/04) и какие в работе (NX‑03).

