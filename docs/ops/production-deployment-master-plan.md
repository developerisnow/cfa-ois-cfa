# –ú–∞—Å—Ç–µ—Ä-–ø–ª–∞–Ω –≤—ã–∫–∞—Ç–∫–∏ –≤ Production

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ  
**–í–ª–∞–¥–µ–ª–µ—Ü:** Technical Lead / DevOps

---

## üéØ –¶–ï–õ–¨

–í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod –≤ production —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –¥–æ–º–µ–Ω—É `https://cfa.capital/` —á–µ—Ä–µ–∑ IP, –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É –û–ò–°.

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ **GitLab:** https://git.telex.global
- ‚úÖ **Kubernetes –∫–ª–∞—Å—Ç–µ—Ä:** Timeweb Cloud (1 worker node, v1.34.1)
- ‚úÖ **–î–æ–º–µ–Ω:** https://cfa.capital/
- ‚úÖ **Ingress NGINX:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **GitLab Agent:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (2 pod'–∞ Running)
- ‚ö†Ô∏è **GitLab Runner:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden (—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- **Services:** identity, issuance, registry, settlement, compliance, fabric-gateway
- **Apps:** api-gateway, portal-issuer, portal-investor, broker-portal, backoffice
- **Helm Charts:** api-gateway, fabric-*, chaincode-*

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. GitLab Runner –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ë–õ–û–ö–ï–†)
**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden, jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è  
**–ü—Ä–∏—á–∏–Ω–∞:** Runner Registration Token –∏—Å—Ç—ë–∫ –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏ –æ–±–Ω–æ–≤–∏—Ç—å ConfigMap

### 2. –ù–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–¥—ã (ingress, gitlab-agent, gitlab-runner)  
**–†–µ—à–µ–Ω–∏–µ:** –í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod, –∑–∞—Ç–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô (–ø–æ—à–∞–≥–æ–≤–æ)

### –§–ê–ó–ê 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GitLab Runner (–ö–†–ò–¢–ò–ß–ù–û)

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å —Ä–∞–±–æ—Ç—É CI/CD pipeline

#### –®–∞–≥ 1.1: –ü–æ–ª—É—á–∏—Ç—å Runner Registration Token
- [ ] –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
- [ ] –†–∞–∑–¥–µ–ª: Runners
- [ ] –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

#### –®–∞–≥ 1.2: –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
```bash
export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
make gitlab-runner-update-token
kubectl delete pods -n gitlab-runner -l app=gitlab-runner
```

#### –®–∞–≥ 1.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```bash
make gitlab-runner-status
# –í GitLab UI: Settings ‚Üí CI/CD ‚Üí Runners ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Runner "Online" –≤ GitLab UI, jobs –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è

---

### –§–ê–ó–ê 2: –¢–µ—Å—Ç–æ–≤—ã–π Pod (MVP –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)

**–¶–µ–ª—å:** –í—ã–∫–∞—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π pod —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ IP/–¥–æ–º–µ–Ω—É

#### –®–∞–≥ 2.1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π deployment
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π nginx deployment
- [ ] –°–æ–∑–¥–∞—Ç—å Service (NodePort –∏–ª–∏ LoadBalancer)
- [ ] –°–æ–∑–¥–∞—Ç—å Ingress –¥–ª—è –¥–æ–º–µ–Ω–∞ cfa.capital

#### –®–∞–≥ 2.2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pod –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ IP –∫–ª–∞—Å—Ç–µ—Ä–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –¥–æ–º–µ–Ω—É (–µ—Å–ª–∏ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –¢–µ—Å—Ç–æ–≤—ã–π pod –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ IP –∏ –¥–æ–º–µ–Ω—É

---

### –§–ê–ó–ê 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitOps (GitLab Agent)

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

#### –®–∞–≥ 3.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
```bash
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent
```

#### –®–∞–≥ 3.2: –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
- [ ] –°–æ–∑–¥–∞—Ç—å `.gitlab/agents/ois-cfa-agent/config.yaml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç–∏ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### –®–∞–≥ 3.3: –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
```
ops/gitops/gitlab-agent/manifests/
‚îú‚îÄ‚îÄ system/      # Ingress, Monitoring
‚îú‚îÄ‚îÄ platform/    # PostgreSQL, Redis (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
‚îî‚îÄ‚îÄ business/    # API Gateway, Services, Frontend
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** GitLab Agent —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ Git

---

### –§–ê–ó–ê 4: –í—ã–∫–∞—Ç–∫–∞ API Gateway (–ø–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å)

**–¶–µ–ª—å:** –í—ã–∫–∞—Ç–∏—Ç—å API Gateway –∫–∞–∫ —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É

#### –®–∞–≥ 4.1: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å Helm chart
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `ops/infra/helm/api-gateway/values-prod.yaml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholder
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Ingress –¥–ª—è cfa.capital

#### –®–∞–≥ 4.2: –í—ã–∫–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Helm
```bash
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-prod.yaml
```

#### –®–∞–≥ 4.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pod –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Ingress
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** API Gateway –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ https://cfa.capital/api

---

### –§–ê–ó–ê 5: CI/CD Pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—ã–∫–∞—Ç–∫–∏

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–±–æ—Ä–∫—É –∏ –≤—ã–∫–∞—Ç–∫—É —á–µ—Ä–µ–∑ GitLab CI

#### –®–∞–≥ 5.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å build jobs
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ build jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—Ä–∞–∑—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ GitLab Registry

#### –®–∞–≥ 5.2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å deploy jobs
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å deploy –¥–ª—è dev/staging/prod
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å GitLab Agent –∏–ª–∏ ArgoCD
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å manual approval –¥–ª—è prod

#### –®–∞–≥ 5.3: –¢–µ—Å—Ç–æ–≤–∞—è –≤—ã–∫–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ pipeline
- [ ] –°–æ–∑–¥–∞—Ç—å MR
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deploy job –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∫–ª–∞—Å—Ç–µ—Ä

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Helm Charts

```
ops/infra/helm/
‚îú‚îÄ‚îÄ api-gateway/          # API Gateway (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
‚îÇ   ‚îú‚îÄ‚îÄ values.yaml       # –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ values-prod.yaml  # Production –∑–Ω–∞—á–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ templates/        # Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ identity/             # Identity Service
‚îú‚îÄ‚îÄ issuance/             # Issuance Service
‚îú‚îÄ‚îÄ registry/             # Registry Service
‚îú‚îÄ‚îÄ settlement/           # Settlement Service
‚îî‚îÄ‚îÄ ...
```

### Ingress –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–æ–º–µ–Ω: `cfa.capital`
- API: `https://cfa.capital/api`
- Portal Issuer: `https://cfa.capital/issuer`
- Portal Investor: `https://cfa.capital/investor`
- Backoffice: `https://cfa.capital/admin`

### Namespace —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
ois-cfa/              # –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
fabric-network/       # Hyperledger Fabric
gitlab-agent/         # GitLab Agent
gitlab-runner/        # GitLab Runner
ingress-nginx/        # Ingress Controller
```

---

## üìù –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Ingress NGINX —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] GitLab Agent —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] GitLab Runner —Ä–∞–±–æ—Ç–∞–µ—Ç (–∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω!)

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] API Gateway –≤—ã–∫–∞—á–µ–Ω
- [ ] Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞
- [ ] DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–∏–ª–∏ –¥–æ—Å—Ç—É–ø –ø–æ IP)

### CI/CD
- [ ] Build jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Deploy jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] GitOps —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ (–º–∏–Ω–∏–º—É–º –¥–ª—è —Ç–µ—Å—Ç–∞)

```bash
# 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Runner
export RUNNER_TOKEN="—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
make gitlab-runner-update-token

# 2. –í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
kubectl apply -f ops/infra/k8s/test-pod.yaml

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
kubectl get svc -n ois-cfa
curl http://<EXTERNAL-IP>
```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [GitLab Runner Troubleshooting](./gitlab-runner-troubleshooting.md)
- [GitOps Setup](./gitops.md)
- [Helm Charts](./helm.md)
- [Ingress Configuration](../infra/k8s/ingress.yaml)

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

1. **–û–¥–∏–Ω worker node** - –Ω–µ—Ç HA, –Ω—É–∂–µ–Ω –º–∏–Ω–∏–º—É–º 3 —É–∑–ª–∞ –¥–ª—è production
2. **–ù–µ—Ç LoadBalancer** - –∏—Å–ø–æ–ª—å–∑—É–µ–º NodePort –∏–ª–∏ Ingress
3. **–¢–æ–∫–µ–Ω Runner** - –º–æ–∂–µ—Ç –∏—Å—Ç–µ—á—å, –Ω—É–∂–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è
4. **DNS** - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IP –≤—Ä–µ–º–µ–Ω–Ω–æ

---

## üìÖ TIMELINE

- **–î–µ–Ω—å 1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å Runner, –≤—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
- **–î–µ–Ω—å 2:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitOps, –≤—ã–∫–∞—Ç–∏—Ç—å API Gateway
- **–î–µ–Ω—å 3:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–∫–∞—Ç–∫–∞
- **–î–µ–Ω—å 4+:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –≤—ã–∫–∞—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å —Å –§–ê–ó–´ 1 - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GitLab Runner

