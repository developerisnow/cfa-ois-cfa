# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 403 Forbidden –¥–ª—è GitLab Runner

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** GitLab Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden –¥–∞–∂–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º  
**–°—Ç–∞—Ç—É—Å:** –¢–æ–∫–µ–Ω —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ ConfigMap, –Ω–æ GitLab –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- ‚úÖ ConfigMap —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω: `GR1348941HYErDk_6wh8UsSenSgsU`
- ‚úÖ Deployment –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç `config.toml`
- ‚úÖ –§–∞–π–ª `config.toml` –≤ pod —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–∫–µ–Ω
- ‚ùå GitLab –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 Forbidden

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
ERROR: Checking for jobs... forbidden
status=POST https://git.telex.global/api/v4/jobs/request: 403 Forbidden
runner=HYErDk_6w
```

---

## üîß –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner Registration Token –º–æ–≥ –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫ –≤ GitLab.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI:**
   - –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners
   - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

2. **–û–±–Ω–æ–≤–∏—Ç—å ConfigMap:**
   ```bash
   # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ops/infra/k8s/gitlab-runner/configmap.yaml
   # –ó–∞–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π
   
   # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
   kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```

3. **–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Makefile:**
   ```bash
   export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
   make gitlab-runner-update-token
   ```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: Runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å –¥—Ä—É–≥–∏–º —Ç–æ–∫–µ–Ω–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner —Å ID `HYErDk_6w` —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ GitLab, –Ω–æ —Å –¥—Ä—É–≥–∏–º —Ç–æ–∫–µ–Ω–æ–º.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–£–¥–∞–ª–∏—Ç—å runner –∏–∑ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - –ù–∞–π—Ç–∏ runner —Å ID `HYErDk_6w`
   - –£–¥–∞–ª–∏—Ç—å –µ–≥–æ

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods:**
   ```bash
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```

3. **Runner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º**

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –£ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ runner'–∞.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å **Runner Registration Token** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `GR...`)
   - –ù–ï Personal Access Token (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `glpat-...`)
   - –ù–ï Deploy Token

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞:**
   - –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ `npk/ois-cfa`
   - –ò–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã/instance (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥—Ä—É–ø–ø–æ–≤–æ–π runner)

---

## üîÑ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê RUNNER

–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É:

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# 1. –£–¥–∞–ª–∏—Ç—å deployment
kubectl delete deployment gitlab-runner -n gitlab-runner

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ pods
kubectl delete pods -n gitlab-runner -l app=gitlab-runner

# 3. –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI
# Settings ‚Üí CI/CD ‚Üí Runners ‚Üí Reset registration token

# 4. –û–±–Ω–æ–≤–∏—Ç—å ConfigMap —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω"
make gitlab-runner-update-token

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å deployment
kubectl apply -f ops/infra/k8s/gitlab-runner/deployment.yaml

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n gitlab-runner
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Checking for jobs..." –ë–ï–ó –æ—à–∏–±–æ–∫ 403
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - Runner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online" –∏ "Active"
   - –°—Ç–∞—Ç—É—Å: –∑–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job:**
   - –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π job –≤ `.gitlab-ci.yml`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ runner'–µ

---

## üìù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í –ö–û–î–ï

### `ops/infra/k8s/gitlab-runner/configmap.yaml`
- ‚úÖ –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω: `token = "GR1348941HYErDk_6wh8UsSenSgsU"`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `mount_propagation = "None"` –¥–ª—è volumes

### `ops/infra/k8s/gitlab-runner/deployment.yaml`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `items` –≤ volume –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `config.toml`

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI** (–µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
2. **–û–±–Ω–æ–≤–∏—Ç—å ConfigMap** —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods**
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å** –≤ GitLab UI
5. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

---

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –Ω–æ –≤—Å–µ –µ—â–µ 403, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –Ω–æ–≤–æ–º—É –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

