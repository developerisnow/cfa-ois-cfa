# МОДЕЛЬ ДАННЫХ
## ОИС ЦФА - Структура данных и сущности

**Версия:** {{VERSION}}  
**Дата:** {{DATE}}  
**Оператор:** {{COMPANY_NAME}} (ОГРН: {{OGRN}}, ИНН: {{INN}})

---

## 1. ОБЩИЕ ПОЛОЖЕНИЯ

### 1.1. Назначение

Настоящий документ описывает модель данных информационной системы {{COMPANY_NAME}} для работы с цифровыми финансовыми активами (ЦФА). Модель данных определяет структуру, типы, связи и ограничения данных, используемых в системе.

### 1.2. Принципы проектирования

**Нормализация:**
- Устранение избыточности данных
- Обеспечение целостности
- Оптимизация хранения
- Упрощение обновлений

**Производительность:**
- Индексирование ключевых полей
- Оптимизация запросов
- Партиционирование больших таблиц
- Кэширование часто используемых данных

**Безопасность:**
- Шифрование чувствительных данных
- Контроль доступа
- Аудит изменений
- Резервирование

---

## 2. ОСНОВНЫЕ СУЩНОСТИ

### 2.1. Пользователи (Users)

**Описание:** Физические и юридические лица, имеющие доступ к системе

**Атрибуты:**
- `user_id` (UUID, PK) - Уникальный идентификатор пользователя
- `user_type` (ENUM) - Тип пользователя (INDIVIDUAL, LEGAL_ENTITY)
- `status` (ENUM) - Статус (ACTIVE, INACTIVE, SUSPENDED, BLOCKED)
- `created_at` (TIMESTAMP) - Дата создания
- `updated_at` (TIMESTAMP) - Дата обновления
- `last_login` (TIMESTAMP) - Последний вход в систему

**Ограничения:**
- `user_id` - уникальный, не null
- `user_type` - не null, значение из списка
- `status` - не null, значение из списка

### 2.2. Физические лица (Individuals)

**Описание:** Персональные данные физических лиц

**Атрибуты:**
- `individual_id` (UUID, PK) - Уникальный идентификатор
- `user_id` (UUID, FK) - Ссылка на пользователя
- `first_name` (VARCHAR(100)) - Имя
- `last_name` (VARCHAR(100)) - Фамилия
- `middle_name` (VARCHAR(100)) - Отчество
- `birth_date` (DATE) - Дата рождения
- `birth_place` (VARCHAR(200)) - Место рождения
- `citizenship` (VARCHAR(50)) - Гражданство
- `passport_series` (VARCHAR(10)) - Серия паспорта
- `passport_number` (VARCHAR(20)) - Номер паспорта
- `passport_issued_by` (VARCHAR(200)) - Кем выдан паспорт
- `passport_issued_date` (DATE) - Дата выдачи паспорта
- `registration_address` (TEXT) - Адрес регистрации
- `residence_address` (TEXT) - Адрес проживания
- `phone` (VARCHAR(20)) - Телефон
- `email` (VARCHAR(100)) - Email
- `snils` (VARCHAR(14)) - СНИЛС
- `inn` (VARCHAR(12)) - ИНН

**Ограничения:**
- `individual_id` - уникальный, не null
- `user_id` - не null, внешний ключ
- `first_name` - не null, длина 1-100
- `last_name` - не null, длина 1-100
- `email` - уникальный, валидный email
- `phone` - уникальный, валидный телефон

### 2.3. Юридические лица (Legal Entities)

**Описание:** Данные юридических лиц

**Атрибуты:**
- `legal_entity_id` (UUID, PK) - Уникальный идентификатор
- `user_id` (UUID, FK) - Ссылка на пользователя
- `full_name` (VARCHAR(500)) - Полное наименование
- `short_name` (VARCHAR(200)) - Сокращенное наименование
- `legal_form` (VARCHAR(100)) - Организационно-правовая форма
- `ogrn` (VARCHAR(15)) - ОГРН
- `inn` (VARCHAR(12)) - ИНН
- `kpp` (VARCHAR(9)) - КПП
- `legal_address` (TEXT) - Юридический адрес
- `postal_address` (TEXT) - Почтовый адрес
- `phone` (VARCHAR(20)) - Телефон
- `email` (VARCHAR(100)) - Email
- `website` (VARCHAR(200)) - Веб-сайт
- `ceo_name` (VARCHAR(200)) - ФИО руководителя
- `ceo_position` (VARCHAR(100)) - Должность руководителя

**Ограничения:**
- `legal_entity_id` - уникальный, не null
- `user_id` - не null, внешний ключ
- `full_name` - не null, длина 1-500
- `ogrn` - уникальный, валидный ОГРН
- `inn` - уникальный, валидный ИНН
- `email` - уникальный, валидный email

### 2.4. Цифровые финансовые активы (Digital Financial Assets)

**Описание:** Информация о ЦФА, выпущенных в системе

**Атрибуты:**
- `cfa_id` (UUID, PK) - Уникальный идентификатор ЦФА
- `issuer_id` (UUID, FK) - Идентификатор эмитента
- `cfa_type` (ENUM) - Тип ЦФА (TOKEN, BOND, SHARE, OTHER)
- `name` (VARCHAR(200)) - Наименование ЦФА
- `symbol` (VARCHAR(20)) - Символ ЦФА
- `description` (TEXT) - Описание ЦФА
- `total_supply` (DECIMAL(20,8)) - Общий объем выпуска
- `issued_amount` (DECIMAL(20,8)) - Выпущенный объем
- `status` (ENUM) - Статус (DRAFT, ACTIVE, SUSPENDED, CANCELLED)
- `created_at` (TIMESTAMP) - Дата создания
- `updated_at` (TIMESTAMP) - Дата обновления
- `activated_at` (TIMESTAMP) - Дата активации

**Ограничения:**
- `cfa_id` - уникальный, не null
- `issuer_id` - не null, внешний ключ
- `cfa_type` - не null, значение из списка
- `name` - не null, длина 1-200
- `symbol` - уникальный, длина 1-20
- `total_supply` - не null, > 0
- `issued_amount` - не null, >= 0, <= total_supply

### 2.5. Владельцы ЦФА (CFA Holders)

**Описание:** Информация о владельцах ЦФА

**Атрибуты:**
- `holder_id` (UUID, PK) - Уникальный идентификатор владельца
- `user_id` (UUID, FK) - Ссылка на пользователя
- `cfa_id` (UUID, FK) - Ссылка на ЦФА
- `balance` (DECIMAL(20,8)) - Баланс
- `frozen_balance` (DECIMAL(20,8)) - Замороженный баланс
- `status` (ENUM) - Статус (ACTIVE, FROZEN, BLOCKED)
- `created_at` (TIMESTAMP) - Дата создания
- `updated_at` (TIMESTAMP) - Дата обновления

**Ограничения:**
- `holder_id` - уникальный, не null
- `user_id` - не null, внешний ключ
- `cfa_id` - не null, внешний ключ
- `balance` - не null, >= 0
- `frozen_balance` - не null, >= 0
- Уникальная комбинация (user_id, cfa_id)

### 2.6. Операции (Transactions)

**Описание:** Операции с ЦФА в системе

**Атрибуты:**
- `transaction_id` (UUID, PK) - Уникальный идентификатор операции
- `transaction_type` (ENUM) - Тип операции (ISSUE, TRANSFER, REDEEM, FREEZE, UNFREEZE)
- `cfa_id` (UUID, FK) - Ссылка на ЦФА
- `from_holder_id` (UUID, FK) - Отправитель (null для ISSUE)
- `to_holder_id` (UUID, FK) - Получатель (null для REDEEM)
- `amount` (DECIMAL(20,8)) - Сумма операции
- `status` (ENUM) - Статус (PENDING, CONFIRMED, FAILED, CANCELLED)
- `created_at` (TIMESTAMP) - Дата создания
- `confirmed_at` (TIMESTAMP) - Дата подтверждения
- `block_hash` (VARCHAR(64)) - Хеш блока в DLT
- `transaction_hash` (VARCHAR(64)) - Хеш транзакции в DLT
- `metadata` (JSONB) - Дополнительные данные

**Ограничения:**
- `transaction_id` - уникальный, не null
- `transaction_type` - не null, значение из списка
- `cfa_id` - не null, внешний ключ
- `amount` - не null, > 0
- `status` - не null, значение из списка
- Для TRANSFER: from_holder_id и to_holder_id не null
- Для ISSUE: from_holder_id null, to_holder_id не null
- Для REDEEM: from_holder_id не null, to_holder_id null

### 2.7. Блоки DLT (DLT Blocks)

**Описание:** Блоки в распределенном реестре

**Атрибуты:**
- `block_id` (UUID, PK) - Уникальный идентификатор блока
- `block_number` (BIGINT) - Номер блока
- `block_hash` (VARCHAR(64)) - Хеш блока
- `previous_hash` (VARCHAR(64)) - Хеш предыдущего блока
- `merkle_root` (VARCHAR(64)) - Корень дерева Меркла
- `timestamp` (TIMESTAMP) - Временная метка
- `transactions_count` (INTEGER) - Количество транзакций
- `created_at` (TIMESTAMP) - Дата создания записи

**Ограничения:**
- `block_id` - уникальный, не null
- `block_number` - уникальный, не null, > 0
- `block_hash` - уникальный, не null
- `previous_hash` - не null (кроме genesis блока)
- `timestamp` - не null

---

## 3. СВЯЗИ МЕЖДУ СУЩНОСТЯМИ

### 3.1. Основные связи

**Users → Individuals (1:1)**
- Один пользователь может быть одним физическим лицом
- Один физическое лицо принадлежит одному пользователю

**Users → Legal Entities (1:1)**
- Один пользователь может быть одним юридическим лицом
- Одно юридическое лицо принадлежит одному пользователю

**Users → CFA Holders (1:N)**
- Один пользователь может владеть несколькими ЦФА
- Один владелец ЦФА принадлежит одному пользователю

**CFAs → CFA Holders (1:N)**
- Один ЦФА может иметь несколько владельцев
- Один владелец ЦФА принадлежит одному ЦФА

**CFAs → Transactions (1:N)**
- Один ЦФА может иметь множество операций
- Одна операция принадлежит одному ЦФА

**CFA Holders → Transactions (1:N)**
- Один владелец может участвовать в множестве операций
- Одна операция может иметь до двух владельцев

### 3.2. Ограничения целостности

**Каскадные удаления:**
- При удалении пользователя удаляются связанные физическое/юридическое лицо
- При удалении ЦФА удаляются связанные владельцы
- При удалении блока удаляются связанные транзакции

**Ограничения проверки:**
- Баланс владельца не может быть отрицательным
- Выпущенный объем не может превышать общий объем
- Транзакция не может быть подтверждена без валидного блока

---

## 4. ИНДЕКСЫ И ПРОИЗВОДИТЕЛЬНОСТЬ

### 4.1. Основные индексы

**Поиск пользователей:**
- `idx_users_email` - по email
- `idx_users_status` - по статусу
- `idx_users_created_at` - по дате создания

**Поиск физических лиц:**
- `idx_individuals_passport` - по паспортным данным
- `idx_individuals_snils` - по СНИЛС
- `idx_individuals_inn` - по ИНН

**Поиск юридических лиц:**
- `idx_legal_entities_ogrn` - по ОГРН
- `idx_legal_entities_inn` - по ИНН
- `idx_legal_entities_name` - по наименованию

**Поиск ЦФА:**
- `idx_cfas_symbol` - по символу
- `idx_cfas_issuer` - по эмитенту
- `idx_cfas_status` - по статусу

**Поиск операций:**
- `idx_transactions_cfa` - по ЦФА
- `idx_transactions_from_holder` - по отправителю
- `idx_transactions_to_holder` - по получателю
- `idx_transactions_status` - по статусу
- `idx_transactions_created_at` - по дате создания

### 4.2. Составные индексы

**Оптимизация запросов:**
- `idx_holders_user_cfa` - (user_id, cfa_id)
- `idx_transactions_cfa_status` - (cfa_id, status)
- `idx_transactions_holder_status` - (from_holder_id, status)
- `idx_blocks_number_hash` - (block_number, block_hash)

---

## 5. ШИФРОВАНИЕ И БЕЗОПАСНОСТЬ

### 5.1. Шифрование данных

**Критически важные данные:**
- Паспортные данные (AES-256)
- СНИЛС (AES-256)
- ИНН (AES-256)
- Адреса (AES-256)
- Телефоны (AES-256)

**Чувствительные данные:**
- Email (AES-128)
- Имена (AES-128)
- Наименования (AES-128)

**Публичные данные:**
- Символы ЦФА
- Описания
- Статусы
- Временные метки

### 5.2. Контроль доступа

**Роли и права:**
- `ADMIN` - полный доступ ко всем данным
- `OPERATOR` - доступ к операционным данным
- `ANALYST` - доступ к аналитическим данным
- `USER` - доступ только к своим данным

**Аудит доступа:**
- Логирование всех операций чтения
- Логирование всех операций изменения
- Контроль доступа к чувствительным данным
- Мониторинг аномальной активности

---

## 6. РЕЗЕРВИРОВАНИЕ И ВОССТАНОВЛЕНИЕ

### 6.1. Стратегия резервирования

**Полное резервное копирование:**
- Ежедневно в 02:00
- Хранение 30 дней
- Сжатие и шифрование

**Инкрементальное копирование:**
- Каждые 4 часа
- Хранение 7 дней
- Быстрое восстановление

**Транзакционное копирование:**
- Непрерывно
- Хранение 24 часа
- Минимальные потери данных

### 6.2. Процедуры восстановления

**Восстановление из полного backup:**
- Время: 2-4 часа
- Потери данных: до 24 часов
- Процедура: автоматическая

**Восстановление из инкрементального backup:**
- Время: 30-60 минут
- Потери данных: до 4 часов
- Процедура: полуавтоматическая

**Восстановление из транзакционного backup:**
- Время: 5-15 минут
- Потери данных: до 1 минуты
- Процедура: автоматическая

---

## 7. МОНИТОРИНГ И АУДИТ

### 7.1. Мониторинг производительности

**Ключевые метрики:**
- Время выполнения запросов
- Количество подключений
- Использование дискового пространства
- Использование памяти

**Алерты:**
- Время выполнения запроса > 1 секунды
- Количество подключений > 80% от максимума
- Использование диска > 90%
- Использование памяти > 85%

### 7.2. Аудит изменений

**Отслеживаемые операции:**
- Создание записей
- Обновление записей
- Удаление записей
- Изменение прав доступа

**Информация аудита:**
- Пользователь, выполнивший операцию
- Время операции
- Тип операции
- Измененные данные
- IP-адрес
- User-Agent

---

## 8. МАСШТАБИРОВАНИЕ

### 8.1. Горизонтальное масштабирование

**Партиционирование:**
- По дате создания (месячные партиции)
- По типу пользователя
- По статусу ЦФА

**Шардирование:**
- По user_id (хеш-функция)
- По cfa_id (диапазоны)
- По географическому региону

### 8.2. Вертикальное масштабирование

**Оптимизация запросов:**
- Использование индексов
- Оптимизация JOIN'ов
- Кэширование результатов
- Материализованные представления

**Оптимизация хранения:**
- Сжатие данных
- Архивирование старых данных
- Очистка временных данных
- Оптимизация типов данных

---

## 9. ИНТЕГРАЦИЯ С DLT

### 9.1. Синхронизация с блокчейном

**Отправка транзакций:**
- Формирование транзакции
- Подписание транзакции
- Отправка в DLT сеть
- Ожидание подтверждения

**Получение данных:**
- Подписка на события
- Получение блоков
- Валидация данных
- Обновление локальной БД

### 9.2. Обеспечение консистентности

**Проверка целостности:**
- Сравнение хешей
- Проверка подписей
- Валидация блоков
- Синхронизация состояний

**Обработка конфликтов:**
- Приоритет DLT данных
- Логирование расхождений
- Уведомление администраторов
- Ручное разрешение

---

## 10. МИГРАЦИИ И ВЕРСИОНИРОВАНИЕ

### 10.1. Управление схемой

**Версионирование схемы:**
- Нумерация версий (1.0, 1.1, 2.0)
- Обратная совместимость
- Планирование миграций
- Откат изменений

**Миграции:**
- Автоматические миграции
- Проверка целостности
- Валидация данных
- Откат при ошибках

### 10.2. Процедуры обновления

**Планирование:**
- Анализ изменений
- Оценка рисков
- Планирование времени
- Подготовка отката

**Выполнение:**
- Создание backup
- Применение миграций
- Валидация данных
- Тестирование функциональности

**Откат:**
- Остановка приложений
- Восстановление из backup
- Применение откатных миграций
- Валидация восстановления

---

## 11. ДОКУМЕНТАЦИЯ И ПОДДЕРЖКА

### 11.1. Техническая документация

**Схема базы данных:**
- ER-диаграммы
- Описание таблиц
- Описание индексов
- Описание ограничений

**API документация:**
- Описание эндпоинтов
- Схемы запросов
- Схемы ответов
- Примеры использования

### 11.2. Процедуры поддержки

**Мониторинг:**
- Автоматические проверки
- Алерты и уведомления
- Дашборды и отчеты
- Логирование событий

**Обслуживание:**
- Регулярные проверки
- Оптимизация производительности
- Очистка данных
- Обновление статистики

---

**Дата создания:** {{DATE}}  
**Автор:** {{AUTHOR}}  
**Версия:** {{VERSION}}  
**Статус:** Утверждено  
**Следующий пересмотр:** {{NEXT_REVIEW_DATE}}

---

## ПРИЛОЖЕНИЯ

### Приложение A: ER-диаграмма
### Приложение B: SQL скрипты создания
### Приложение C: Примеры запросов
### Приложение D: Процедуры миграции
### Приложение E: История изменений
