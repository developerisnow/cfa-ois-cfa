{{- if .Values.secrets.rotation.enabled }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "fabric-peer.fullname" . }}-secrets-rotation
  namespace: {{ .Release.Namespace | default "fabric-network" }}
  labels:
    {{- include "fabric-peer.labels" . | nindent 4 }}
    app.kubernetes.io/component: secrets-rotation
spec:
  schedule: {{ .Values.secrets.rotation.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "fabric-peer.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: secrets-rotation
        spec:
          restartPolicy: OnFailure
          serviceAccountName: {{ include "fabric-peer.serviceAccountName" . }}
          containers:
            - name: rotate-secrets
              image: vault:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "Starting secrets rotation for {{ .Values.organization.name }}"
                  
                  # Vault authentication
                  vault auth -method=kubernetes \
                    role={{ .Values.secrets.rotation.vaultRole }} \
                    token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                  
                  # Rotate MSP certificates
                  echo "Rotating MSP certificates..."
                  vault kv put secret/fabric/{{ .Values.organization.name }}/msp \
                    @/etc/hyperledger/fabric/msp/rotated.json || echo "MSP rotation failed"
                  
                  # Rotate TLS certificates
                  echo "Rotating TLS certificates..."
                  vault kv put secret/fabric/{{ .Values.organization.name }}/tls \
                    @/etc/hyperledger/fabric/tls/rotated.json || echo "TLS rotation failed"
                  
                  # Restart pods to pick up new secrets
                  echo "Restarting pods..."
                  kubectl rollout restart deployment/{{ include "fabric-peer.fullname" . }} \
                    -n {{ .Release.Namespace | default "fabric-network" }}
                  
                  echo "Secrets rotation completed"
              env:
                - name: VAULT_ADDR
                  value: {{ .Values.secrets.rotation.vaultAddr | quote }}
                - name: VAULT_NAMESPACE
                  value: {{ .Values.secrets.rotation.vaultNamespace | quote }}
              volumeMounts:
                - name: msp
                  mountPath: /etc/hyperledger/fabric/msp
                  readOnly: true
                - name: tls
                  mountPath: /etc/hyperledger/fabric/tls
                  readOnly: true
                - name: service-account
                  mountPath: /var/run/secrets/kubernetes.io/serviceaccount
                  readOnly: true
          volumes:
            - name: msp
              secret:
                secretName: {{ .Values.secrets.msp.name }}
            - name: tls
              secret:
                secretName: {{ .Values.secrets.tls.name }}
            - name: service-account
              projected:
                sources:
                  - serviceAccountToken:
                      path: token
          {{- if .Values.secrets.rotation.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml .Values.secrets.rotation.imagePullSecrets | nindent 12 }}
          {{- end }}
{{- end }}

