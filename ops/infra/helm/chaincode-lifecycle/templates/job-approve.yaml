{{- range .Values.chaincode }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: chaincode-approve-{{ .name }}-{{ .version }}
  namespace: {{ $.Values.namespace }}
  labels:
    {{- include "chaincode-lifecycle.labels" $ | nindent 4 }}
    app.kubernetes.io/component: chaincode-approve
    chaincode: {{ .name }}
    version: {{ .version }}
spec:
  ttlSecondsAfterFinished: {{ $.Values.job.ttlSecondsAfterFinished }}
  backoffLimit: {{ $.Values.job.backoffLimit }}
  activeDeadlineSeconds: {{ $.Values.job.activeDeadlineSeconds }}
  template:
    metadata:
      labels:
        {{- include "chaincode-lifecycle.selectorLabels" $ | nindent 8 }}
        chaincode: {{ .name }}
    spec:
      restartPolicy: Never
      serviceAccountName: chaincode-lifecycle
      containers:
        - name: approve
          image: hyperledger/fabric-tools:2.5
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Approving chaincode {{ .name }} v{{ .version }} sequence {{ .sequence }}"
              
              # Get package ID from first peer
              PEER_SERVICE="{{ (index $.Values.peers 0).service }}.{{ $.Values.namespace }}.svc.cluster.local"
              PEER_PORT="{{ (index $.Values.peers 0).port }}"
              
              # Wait for peer to be ready
              until peer node status; do
                echo "Waiting for peer to be ready..."
                sleep 5
              done
              
              # Query installed chaincode to get package ID
              PACKAGE_ID=$(peer lifecycle chaincode queryinstalled | grep -A 1 "{{ .name }}" | grep "Package ID" | awk '{print $3}')
              
              if [ -z "$PACKAGE_ID" ]; then
                echo "Error: Package ID not found for {{ .name }}"
                exit 1
              fi
              
              echo "Package ID: $PACKAGE_ID"
              
              # Approve on all peers
              {{- range $peer := $.Values.peers }}
              echo "Approving on {{ $peer.name }}..."
              export CORE_PEER_ADDRESS="{{ $peer.service }}.{{ $.Values.namespace }}.svc.cluster.local:{{ $peer.port }}"
              peer lifecycle chaincode approveformyorg \
                -o {{ $.Values.orderer.service }}.{{ $.Values.namespace }}.svc.cluster.local:{{ $.Values.orderer.port }} \
                --channelID {{ $chaincode.channel }} \
                --name {{ $chaincode.name }} \
                --version {{ $chaincode.version }} \
                --package-id $PACKAGE_ID \
                --sequence {{ $chaincode.sequence }} \
                {{- if $.Values.orderer.tls.enabled }}
                --tls \
                --cafile /etc/hyperledger/fabric/orderer-tlsca.crt
                {{- end }}
              {{- end }}
              
              echo "Chaincode {{ .name }} approved successfully"
          env:
            - name: CORE_PEER_LOCALMSPID
              value: {{ $.Values.organization.mspId | quote }}
            - name: CORE_PEER_TLS_ENABLED
              value: "{{ $.Values.orderer.tls.enabled }}"
            - name: CORE_PEER_TLS_ROOTCERT_FILE
              value: "/etc/hyperledger/fabric/tls/ca.crt"
            - name: CORE_PEER_MSPCONFIGPATH
              value: {{ $.Values.organization.mspPath | quote }}
            - name: CORE_PEER_ADDRESS
              value: "{{ (index $.Values.peers 0).service }}.{{ $.Values.namespace }}.svc.cluster.local:{{ (index $.Values.peers 0).port }}"
          volumeMounts:
            - name: msp
              mountPath: {{ $.Values.organization.mspPath }}
              readOnly: true
            - name: tls
              mountPath: /etc/hyperledger/fabric/tls
              readOnly: true
            - name: orderer-tls
              mountPath: /etc/hyperledger/fabric
              readOnly: true
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: msp
          secret:
            secretName: {{ $.Values.secrets.msp.name }}
        - name: tls
          secret:
            secretName: {{ $.Values.secrets.tls.name }}
        - name: orderer-tls
          secret:
            secretName: {{ $.Values.secrets.ordererTls.name }}
{{- end }}

