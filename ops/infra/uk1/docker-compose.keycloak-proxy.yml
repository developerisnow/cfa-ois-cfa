# Override file to expose Keycloak via public hostname behind nginx sidecar.
# Usage: docker compose -f docker-compose.yml -f docker-compose.override.yml -f ops/infra/uk1/docker-compose.keycloak-proxy.yml up -d keycloak keycloak-proxy

services:
  keycloak:
    ports:
      - "8081:8080"
    environment:
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTP_MANAGEMENT_ENABLED: "true"
      KC_HOSTNAME_URL: ${KEYCLOAK_PUBLIC_URL:-https://auth.cfa.llmneighbors.com}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_FEATURES: hostname:v1
    networks:
      ois-network:
        aliases:
          - keycloak

  keycloak-proxy:
    image: nginx:1.27-alpine
    container_name: ois-keycloak-proxy
    depends_on:
      - keycloak
    restart: unless-stopped
    volumes:
      - ./ops/keycloak/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/keycloak:/etc/nginx/tls:ro
    ports:
      - "8080:8080"
      - "8443:8443"
    networks:
      - ois-network
