# Improved GitLab CI/CD (sample) â€” Kaniko, Trivy, Review Apps, Rollback

stages:
  - verify
  - build
  - test
  - scan
  - package
  - deploy
  - promote
  - rollback

default:
  retry: 1
  interruptible: true

variables:
  DOCKER_CONFIG: /kaniko/.docker/
  IMAGE_TAG_SHA: "$CI_COMMIT_SHA"
  IMAGE_TAG_REF: "$CI_COMMIT_REF_SLUG"
  REGISTRY: "$CI_REGISTRY_IMAGE"
  ARGOCD_IMAGE: "argoproj/argocd:v2.12.3"
  KUBECTL_IMAGE: "bitnami/kubectl:1.30"

.kaniko_template: &kaniko_template
  image: gcr.io/kaniko-project/executor:v1.23.2-debug
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {"auths": {"$CI_REGISTRY": {"username": "$CI_REGISTRY_USER", "password": "$CI_REGISTRY_PASSWORD"}}}
      EOF
  script:
    - >
      /kaniko/executor
      --context "$BUILD_CONTEXT"
      --dockerfile "$DOCKERFILE"
      --destination "$REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA"
      --destination "$REGISTRY/$IMAGE_NAME:$IMAGE_TAG_REF"
      --cache=true --cache-ttl=168h
  rules:
    - if: '$CI_COMMIT_BRANCH || $CI_COMMIT_TAG'

verify:ci-lint:
  stage: verify
  image: alpine:3.20
  script:
    - apk add --no-cache yq
    - yq '.stages' .gitlab-ci.yml >/dev/null || true

# Backend services (examples)
build:api-gateway:
  <<: *kaniko_template
  stage: build
  variables:
    IMAGE_NAME: api-gateway
    DOCKERFILE: apps/api-gateway/Dockerfile
    BUILD_CONTEXT: .

build:registry:
  <<: *kaniko_template
  stage: build
  variables:
    IMAGE_NAME: registry
    DOCKERFILE: services/registry/Dockerfile
    BUILD_CONTEXT: .

# Tests (example .NET)
test:unit:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:9.0
  script:
    - dotnet restore
    - dotnet test --no-restore --logger "trx;LogFileName=test-results.trx" --logger "junit;LogFileName=junit.xml" --collect:"XPlat Code Coverage" --results-directory:./coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths: [coverage/]

scan:trivy:
  stage: scan
  image: aquasec/trivy:0.51.0
  script:
    - trivy image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 "$REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA" || exit 1
    - trivy image --format cyclonedx --output sbom.cdx.json "$REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA"
  artifacts:
    when: always
    paths: [sbom.cdx.json]
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG'

package:helm-lint:
  stage: package
  image: alpine/helm:3.15.4
  script:
    - helm lint ops/infra/helm/api-gateway || true

# Review Apps (ephemeral)
deploy:review:
  stage: deploy
  image: $KUBECTL_IMAGE
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://$CI_COMMIT_REF_SLUG.review.example.com
    on_stop: stop:review
    auto_stop_in: 24 hours
  script:
    - echo "Patch values to tag=$CI_COMMIT_SHA (sample)"
    - sed -i "s/tag:.*/tag: \"$CI_COMMIT_SHA\"/" ops/infra/helm/api-gateway/values-dev.yaml || true
  rules:
    - if: '$CI_MERGE_REQUEST_IID'

stop:review:
  stage: deploy
  image: $KUBECTL_IMAGE
  when: manual
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - echo "Review environment cleanup placeholder"
  rules:
    - if: '$CI_MERGE_REQUEST_IID'

# Staging (ArgoCD)
deploy:staging:
  stage: deploy
  image: $ARGOCD_IMAGE
  variables:
    CI_ENVIRONMENT_NAME: staging
  environment:
    name: staging
    url: https://staging.example.com
  script:
    - argocd login "$ARGOCD_SERVER" --username "$ARGOCD_USER" --password "$ARGOCD_PASSWORD" --grpc-web --insecure
    - argocd app sync ois-staging --grpc-web --timeout 300 --prune --self-heal
    - argocd app wait ois-staging --grpc-web --timeout 300 --health
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# Production (manual promote)
promote:prod:
  stage: promote
  image: $ARGOCD_IMAGE
  when: manual
  environment:
    name: production
    url: https://prod.example.com
  script:
    - argocd login "$ARGOCD_SERVER" --username "$ARGOCD_USER" --password "$ARGOCD_PASSWORD" --grpc-web --insecure
    - argocd app sync ois-prod --grpc-web --timeout 600 --prune --self-heal
    - argocd app wait ois-prod --grpc-web --timeout 600 --health
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'

rollback:prod:
  stage: rollback
  image: $ARGOCD_IMAGE
  when: manual
  script:
    - argocd login "$ARGOCD_SERVER" --username "$ARGOCD_USER" --password "$ARGOCD_PASSWORD" --grpc-web --insecure
    - argocd app history ois-prod
    - argocd app rollback ois-prod --grpc-web --revision "$REVISION"

